# Docker-compose example

In this example, EJBCA makes use of the Postgres database and the Node.js Application writes the data to MongoDB.
It is possible to execute more than one container of the component at the same time, for that, just uncomment the section referring to the second component in the docker-compose.yml file.

The component is configured with the environment variables:

| Variable                 | Value  | Description |
|--------------------------|--------|-------------|
|EJBCA_PERFORM_DOJOT_SETUP | "true" | Configure the EJBCA according to what the dojot platform needs. |
|EJBCA_EXTERNAL_ACCESS     | "true" | Enables external access to the EJBCA server. By default, access is only allowed through the 127.0.0.1 interface.<br>Note that when the EJBCA ports are binded with the host machine ports, this variable loses its purpose. |
|EJBCA_ADMIN_USER          | "true" | Creates a user with direct access to the EJBCA with super admin permissions. Useful to view the settings through a graphical web interface. |


This example binds ports 3000, 8080, 8443 to your localhost. If these ports are in use by your host, just map them to different values.

| port | process     | description |
|------|-------------|-------------|
| 3000 | Node.js App | It is through this port that you have access to the component's REST API |
| 8080 | EJBCA       | This port gives direct access to the EJBCA's public web interface. In a production environment, do not release this port for external access. |
| 8443 | EJBCA       | This port gives direct access to the EJBCA's private web interface. To access the restricted area, you must have a valid certificate issued by the EJBCA and installed in your browser. In a production environment, do not release this port for external access. |

We can explore the component and its Endpoints through port 3000. More details are found in the main [README](./../../README.md) of the component.

If you are curious and want to know what EJBCA's public graphical interface looks like, we can type in the browser the address:<br>`http://localhost:8080/ejbca/`

As we run the component with the environment variable `EJBCA_ADMIN_USER` enabled, we can obtain the credentials to access the EJBCA restricted area and have access to all of its settings.

Before accessing the restricted area, we need to find out what was the Super Admin *username / password* that the component generated for us. To do this, run this command in the terminal:<br>`docker exec --user root -it [YOUR_CONTAINER_ID] /bin/cat /mnt/persistent/private/admin-enrollment-info.txt`

You will see something like this:
```
***************************************************
* Super Admin client certificate enrollment URL:  *
***************************************************
URL: https://127.0.0.1:8443/ejbca/enrol/keystore.jsp
Username: admin
Password: +ihKMor2H24GikhRFNZFPCLP
***************************************************
* Once the P12 is downloaded, use the password to *
* import it on browser.                           *
***************************************************
```

The important thing about this output is the values in front of *Username* (**admin**) and *Password* (**+ihKMor2H24GikhRFNZFPCLP**). In your case, this values will be different.

With this data in hand, we will be able to obtain our access credential to the restricted area of the EJBCA. To do this, access the URL:<br>`https://127.0.0.1:8443/ejbca/enrol/keystore.jsp`

The browser will show you an alert message like: *Your connection is not private*, but do not be afraid, this is because the browser does not trust the certificate on this page (as it was generated by the EJBCA).<br>
Inform your browser that you intend to *proceed* even though it is *unsafe*, once this is done, you will have access to the *Keystore Enrollment* page. This is where we get our access credential to the restricted area of the EJBCA.<br>
In the form being presented on the page, enter the values for *Username* and *Password* and click the button to confirm.<br>
The next page will be the *EJBCA Token Certificate Enrollment*, in it, we have a combobox called *Key specification*. We must select the option **RSA 4096 bits** and leave the combobox *Certificate profile* as **ENDUSER**, then click on the *Enroll* button.<br>
Once this is done, a file with the extension `.p12` will be downloaded, this file *must be installed* in your browser as a client certificate. During the installation process, the password used to generate this file will be requested again. Check your browser's documentation on how to import certificates. The `.p12` file can be understood as a certificate encrypted with a password.

After importing the .p12 file in your browser, access the URL: `https://127.0.0.1:8443/ejbca/adminweb/`.

If all goes well, you will have access to the restricted area of the EJBCA. Remember that in a production environment this area is not accessible and take care not to change the settings, as they must be made through scripts of this component.


Remember that the EJBCA is encapsulated by the component and the Node.js application is the one who must communicate with it. Direct access to the EJBCA is for development and debugging purposes only.
For more details, you can consult directly the [EJBCA documentation](https://www.ejbca.org/documentation/).