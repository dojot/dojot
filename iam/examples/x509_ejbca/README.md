# Docker-compose example

In this example, EJBCA Server makes use of the _Postgres_ database and the
_x509-identity-mgmt_ component writes the data to _MongoDB_.
It is possible to execute more than one container of the EJBCA Server or the
_x509-identity-mgmt_ component at the same time, for that, just edit (duplicate)
the section referring these services in the docker-compose.yml file.

The EJBCA Server is configured with the environment variables:

| Variable                 | Value  | Description |
|--------------------------|--------|-------------|
|EJBCA_EXTERNAL_ACCESS     | "true" | Enables external access to the EJBCA server. By default, access is only allowed through the 127.0.0.1 interface.<br>Note that when the EJBCA ports are binded with the host machine ports, this variable loses its purpose. |
|EJBCA_ADMIN_USER          | "true" | Creates a user with direct access to the EJBCA with super admin permissions. Useful to view the settings through a graphical web interface. |


This example binds the following ports to your _localhost_:

 - `3000` for the x509-identity-mgmt component;
 - `8080` and `8443` for EJBCA Server;
 - `5432` for Postgres;
 - `5050` for PgAdmin (Postgres web console);
 - `27017` for MongoDB;
 - `6060` for MongoBD web console;

If these ports are in use by your host, just map them to different values.

We can explore the _x509-identity-mgmt_ component and its Endpoints through port
`3000`. More details are found in the [README](./../../x509-identity-mgmt/README.md)
of the component.

If you are curious and want to know what EJBCA's public graphical interface
looks like, we can type in the browser the address:<br>`http://localhost:8080/ejbca/`

As we run the EJBCA Server with the environment variable `EJBCA_ADMIN_USER`
enabled, we can obtain the credentials to access the EJBCA restricted area and
have access to all of its settings.

Before accessing the restricted area, we need to find out what was the
Super Admin *username/password* that the component generated for us.
To do this, we need to execute a command inside the EJBCA container:

```bash
docker exec --user root -it [EJBCA_CONTAINER_ID] /bin/cat /mnt/persistent/enrollment/admin-enrollment-info.txt
```

You will see something like this:
```
***************************************************
* Super Admin client certificate enrollment URL:  *
***************************************************
URL: https://127.0.0.1:8443/ejbca/enrol/keystore.jsp
Username: admin
Password: +ihKMor2H24GikhRFNZFPCLP
***************************************************
* Once the P12 is downloaded, use the password to *
* import it on browser.                           *
***************************************************
```

The important thing about this output is these values in front of *Username*
(**admin**) and *Password* (**+ihKMor2H24GikhRFNZFPCLP**). In your case, this
values will be different.

With this data in hand, we will be able to obtain our access credential to the
restricted area of the EJBCA. To do this, access the URL:
`https://127.0.0.1:8443/ejbca/enrol/keystore.jsp`

The browser will show you an alert message like: *Your connection is not private*,
but do not be afraid, this is because the browser does not trust the certificate
on this page (as it was generated by the EJBCA).<br>
Inform your browser that you intend to *proceed* even though it is *unsafe*,
once this is done, you will have access to the *Keystore Enrollment* page.
This is where we get our access credential to the restricted area of the EJBCA.<br>
In the form being presented on the page, enter the values for *Username* and
*Password* and click the button to confirm.<br>
The next page will be the *EJBCA Token Certificate Enrollment*, in it, we have a
combobox called *Key specification*. We must select the option **RSA 4096 bits**
and leave the combobox *Certificate profile* as **ENDUSER**, then click on the
*Enroll* button.<br>
Once this is done, a file with the extension `.p12` will be downloaded, this
file *must be installed* in your browser as a client certificate. During the
installation process, the password used to generate this file will be requested
again. Check your browser's documentation on how to import certificates.
The `.p12` file can be understood as a certificate encrypted with a password.

After importing the .p12 file in your browser, access the URL:
`https://127.0.0.1:8443/ejbca/adminweb/`.

If all goes well, you will have access to the restricted area of the EJBCA.
Remember that in a production environment this area is not accessible and take
care not to change the settings, as they must be made through scripts of this
component.
For more details, you can consult directly the
[EJBCA documentation](https://www.ejbca.org/documentation/).